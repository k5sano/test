# MT-2ベース VST3プラグイン開発

## プロジェクト概要

BOSS MT-2 Metal Zoneの回路をDSPモデリングしたVST3ディストーションプラグイン。JUCE フレームワークで開発。MT-2の忠実な再現をベースに、実機にはない拡張機能を追加する。

* * *

## シグナルチェーン

```
Input
  │
  ├─ [入力バッファ]
  │
  ├─ [Gain Stage 1] ── ダイオード・フィードバック・クリッピング (ダイオード種別可変)
  ├─ [段間フィルタ] ── HPF ~200Hz / LPF ~5.5kHz
  ├─ [Gain Stage 2] ── ダイオード・フィードバック・クリッピング (ダイオード種別可変)
  │
  ├─ [Parametric EQ] ── 3バンド (Low Shelf / Mid Peak / High Shelf) + Qコントロール
  │
  ├─ [出力レベル]
  │
  └─ Output
```

* * *

## MT-2コア部分の設計

### ゲインステージ (2段直列)

各段はオペアンプの**フィードバックループ内にアンチパラレル・ダイオード対**を配置した非反転増幅回路。ハードクリッピングではなくソフトクリッピング。

**ダイオード方程式:**

Id​(V)\=2Is​sinh(nVT​V​)

**回路方程式 (暗黙的非線形):**

Vout​+Rf​⋅2Is​sinh(nVT​Vout​​)\=Vin​⋅Gain

Newton-Raphson法でサンプルごとに解く。前サンプルの出力を初期推定値に使い高速収束させる(通常3〜4回)。

**段間フィルタ:** 1次HPF (fc≈200Hz) + 1次LPF (fc≈5500Hz)。これがMT-2のキャラクターを決定的に支配する。省略不可。

**オーバーサンプリング:** 4x必須。`juce::dsp::Oversampling` を使用。ダイオードクリッピングは高次倍音を大量生成するためエイリアシング対策が不可欠。

* * *

## 拡張機能①: ダイオード・モーフィング (Feature A)

### 概要

クリッピングダイオードの種類をノブ一つで連続的にモーフィングできる機能。Stage 1 / Stage 2 それぞれ独立制御、またはリンクモードを設ける。

### ダイオードモデル定義

| モデル名 | Is | n | 音の傾向 |
| --- | --- | --- | --- |
| Silicon (MT-2 stock) | 2.52e-9 | 1.7 | 標準、ジリジリ |
| Germanium | 2.2e-8 | 1.05 | 柔らかい、ヴィンテージファズ寄り |
| LED | 4.35e-10 | 1.9 | 硬い、ヘッドルーム大、クランチ |
| Schottky | 7.4e-9 | 1.9 | 攻撃的、エッジが立つ |
| No Clip (bypass) | \- | \- | ダイオード無効 = クリーンブースト |

### パラメータ

| パラメータ名 | ID | 範囲 | デフォルト | 説明 |
| --- | --- | --- | --- | --- |
| Diode Morph | `diode_morph` | 0.0〜1.0 | 0.0 | Si→Ge→LED→Schottky→NoClip を連続スイープ |
| Diode Link | `diode_link` | bool | true | true: 両ステージ同じダイオード / false: Stage2は別ノブ |
| Diode Morph 2 | `diode_morph_2` | 0.0〜1.0 | 0.0 | Link=false時のみ有効。Stage2用 |

### 実装方針

ノブ値 0.0〜1.0 を4区間に分割し、隣接するモデルの `Is` と `n` を線形補間。No Clipモードではダイオード電流計算をバイパスし `Vout = Vin * Gain` とする。NoClipへの遷移はクロスフェードで処理。

* * *

## 拡張機能②: パラメトリックEQ Q コントロール (Feature B)

### 概要

MT-2のギャラクティックEQを拡張し、MidバンドのQ値をユーザーが操作可能にする。実機MT-2のMid Qは約1.5固定だが、これを 0.3（極めて広い）〜 10.0（鋭いノッチ/ピーク）まで可変にする。

### パラメータ一覧 (EQセクション全体)

| パラメータ名 | ID | 範囲 | デフォルト | 説明 |
| --- | --- | --- | --- | --- |
| Low | `eq_low` | 0.0〜1.0 | 0.5 | Low Shelf ±15dB |
| Mid Level | `eq_mid` | 0.0〜1.0 | 0.5 | Mid Peak ±20dB |
| Mid Freq | `eq_mid_freq` | 0.0〜1.0 | 0.5 | 200Hz〜5kHz 対数スイープ |
| **Mid Q** | **`eq_mid_q`** | **0.0〜1.0** | **0.3** | **Q値 0.3〜10.0 対数マッピング** |
| High | `eq_high` | 0.0〜1.0 | 0.5 | High Shelf ±15dB |

### Mid Q マッピング

```
Q = 0.3 * (10.0 / 0.3) ^ param
→ param=0.0 : Q=0.3 (ブロードなブースト/カット)
→ param=0.3 : Q≈1.5 (MT-2ストック相当)
→ param=1.0 : Q=10.0 (鋭いレゾナンスピーク / 外科的カット)
```

デフォルト値 0.3 でMT-2オリジナルの Q≈1.5 を再現。

### EQフィルタ実装

3バンドすべて Biquad (RBJ Audio EQ Cookbook 準拠)。Mid PeakバンドのみQ可変。Low Shelf / High Shelf のQは固定 (0.707)。係数更新はブロック先頭で1回行い、ブロック内はダイレクトフォームII転置で処理。

* * *

## 共通パラメータ (MT-2コア部)

| パラメータ名 | ID | 範囲 | デフォルト | 説明 |
| --- | --- | --- | --- | --- |
| Dist | `dist` | 0.0〜1.0 | 0.5 | ゲイン量。対数マッピングで実効ゲイン 5.6〜200 |
| Level | `level` | 0.0〜1.0 | 0.5 | 出力レベル |

* * *

## 全パラメータID一覧

```
dist           -- ゲイン量
level          -- 出力レベル
diode_morph    -- ダイオード種別 (Stage1 / リンク時は両方)
diode_link     -- Stage1/2 リンク on/off
diode_morph_2  -- ダイオード種別 Stage2 (リンクoff時)
eq_low         -- Low Shelf
eq_mid         -- Mid Level
eq_mid_freq    -- Mid Frequency
eq_mid_q       -- Mid Q
eq_high        -- High Shelf
```

計 **10パラメータ**。

* * *

## 技術要件

| 項目 | 仕様 |
| --- | --- |
| フレームワーク | JUCE 7 or 8 |
| プラグイン形式 | VST3 (AUも可能なら対応) |
| 処理精度 | 内部 double (64bit float) |
| オーバーサンプリング | 4x (`juce::dsp::Oversampling`) |
| サンプルレート | 44.1kHz〜192kHz 対応 |
| レイテンシ | オーバーサンプリング由来のレイテンシを `setLatencySamples()` で報告 |
| パラメータ管理 | `AudioProcessorValueTreeState` |
| スレッドセーフ | パラメータ読み取りは `getRawParameterValue()` のアトミック読み出し。EQ係数更新はオーディオスレッドで |
| GUI | 最初はジェネリックエディタで可。後からカスタムUI化 |

* * *

## クラス構成案

```
MT2Plugin : juce::AudioProcessor
  ├── MT2GainStage
  │     ├── DiodeFeedbackClipper  (×2: stage1, stage2)
  │     ├── OnePoleHPF            (段間)
  │     └── OnePoleLPF            (段間)
  ├── DiodeMorpher               (Is/n の補間ロジック)
  ├── MT2ToneStack
  │     ├── BiquadFilter (Low Shelf)
  │     ├── BiquadFilter (Mid Peak, Q可変)
  │     └── BiquadFilter (High Shelf)
  └── juce::dsp::Oversampling<double>
```

* * *

## 次チャットへの依頼事項

1.  **仕様書 (詳細設計)**: 上記を正式な設計ドキュメントとして整形
2.  **ソースコード一式**: PluginProcessor.h/.cpp, PluginEditor.h/.cpp, DSPクラス群を完全実装
3.  CMakeLists.txt (JUCEのCMakeビルド構成)

* * *

## 補足: 将来追加を検討中の機能 (今回は未実装)

-   **Power Sag** (電池消耗シミュレーション)
-   **Chaos Feedback** (自己共振フィードバック)
-   **Stereo Doubler** (デチューン・ダブラー)
-   **Gate Sequencer** (リズミック・ゲート)

これらは第2フェーズで追加予定。コア設計時に後から挿入しやすいよう、シグナルチェーンをモジュラーに設計しておくこと。